<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExpenseService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">manager</a> &gt; <a href="index.source.html" class="el_package">com.revature.service</a> &gt; <span class="el_source">ExpenseService.java</span></div><h1>ExpenseService.java</h1><pre class="source lang-java linenums">package com.revature.service;

import com.revature.repository.ApprovalRepository;
import com.revature.repository.ExpenseRepository;
import com.revature.repository.ExpenseWithUser;
import com.revature.repository.User;

import java.io.StringWriter;
import java.util.List;
import java.util.Optional;

/**
 * Service for expense management business logic.
 * Handles expense approvals, reporting, and related operations.
 */
public class ExpenseService {
    private final ExpenseRepository expenseRepository;
    private final ApprovalRepository approvalRepository;
    
<span class="fc" id="L20">    public ExpenseService(ExpenseRepository expenseRepository, ApprovalRepository approvalRepository) {</span>
<span class="fc" id="L21">        this.expenseRepository = expenseRepository;</span>
<span class="fc" id="L22">        this.approvalRepository = approvalRepository;</span>
<span class="fc" id="L23">    }</span>
    
    /**
     * Get all pending expenses for manager review.
     * @return List of pending expenses with user information
     */
    public List&lt;ExpenseWithUser&gt; getPendingExpenses() {
<span class="fc" id="L30">        return expenseRepository.findPendingExpensesWithUsers();</span>
    }
    
    /**
     * Approve an expense.
     * @param expenseId the expense ID to approve
     * @param managerId the manager's user ID
     * @param comment optional comment from manager
     * @return true if approval was successful
     */
    public boolean approveExpense(int expenseId, int managerId, String comment) {
<span class="fc" id="L41">        return approvalRepository.updateApprovalStatus(expenseId, &quot;approved&quot;, managerId, comment);</span>
    }
    
    /**
     * Deny an expense.
     * @param expenseId the expense ID to deny
     * @param managerId the manager's user ID
     * @param comment optional comment from manager
     * @return true if denial was successful
     */
    public boolean denyExpense(int expenseId, int managerId, String comment) {
<span class="fc" id="L52">        return approvalRepository.updateApprovalStatus(expenseId, &quot;denied&quot;, managerId, comment);</span>
    }
    
    /**
     * Get expenses for a specific employee.
     * @param employeeId the employee's user ID
     * @return List of expenses for the employee
     */
    public List&lt;ExpenseWithUser&gt; getExpensesByEmployee(int employeeId) {
<span class="fc" id="L61">        return expenseRepository.findExpensesByUser(employeeId);</span>
    }
    
    /**
     * Get expenses by category (description contains the category text).
     * @param category the category to filter by
     * @return List of expenses matching the category
     */
    public List&lt;ExpenseWithUser&gt; getExpensesByCategory(String category) {
<span class="nc" id="L70">        return expenseRepository.findExpensesByCategory(category);</span>
    }
    
    /**
     * Get expenses within a date range.
     * @param startDate start date (YYYY-MM-DD format)
     * @param endDate end date (YYYY-MM-DD format)
     * @return List of expenses within the date range
     */
    public List&lt;ExpenseWithUser&gt; getExpensesByDateRange(String startDate, String endDate) {
<span class="nc" id="L80">        return expenseRepository.findExpensesByDateRange(startDate, endDate);</span>
    }
    
    /**
     * Get all expenses.
     * @return List of all expenses with user information
     */
    public List&lt;ExpenseWithUser&gt; getAllExpenses() {
<span class="fc" id="L88">        return expenseRepository.findAllExpensesWithUsers();</span>
    }
    
    /**
     * Generate a CSV report of expenses.
     * @param expenses the list of expenses to include in the report
     * @return CSV string representation of the expenses
     */
    public String generateCsvReport(List&lt;ExpenseWithUser&gt; expenses) {
<span class="fc" id="L97">        StringWriter csvWriter = new StringWriter();</span>
        
        // CSV Header
<span class="fc" id="L100">        csvWriter.append(&quot;Expense ID,Employee,Amount,Description,Date,Status,Reviewer,Comment,Review Date\n&quot;);</span>
        
        // CSV Data
<span class="fc bfc" id="L103" title="All 2 branches covered.">        for (ExpenseWithUser expenseWithUser : expenses) {</span>
<span class="fc" id="L104">            csvWriter.append(String.valueOf(expenseWithUser.getExpense().getId())).append(&quot;,&quot;);</span>
<span class="fc" id="L105">            csvWriter.append(escapeCsvValue(expenseWithUser.getUser().getUsername())).append(&quot;,&quot;);</span>
<span class="fc" id="L106">            csvWriter.append(String.valueOf(expenseWithUser.getExpense().getAmount())).append(&quot;,&quot;);</span>
<span class="fc" id="L107">            csvWriter.append(escapeCsvValue(expenseWithUser.getExpense().getDescription())).append(&quot;,&quot;);</span>
<span class="fc" id="L108">            csvWriter.append(expenseWithUser.getExpense().getDate()).append(&quot;,&quot;);</span>
<span class="fc" id="L109">            csvWriter.append(expenseWithUser.getApproval().getStatus()).append(&quot;,&quot;);</span>
            
            // Reviewer (might be null for pending expenses)
<span class="fc" id="L112">            Integer reviewerId = expenseWithUser.getApproval().getReviewer();</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (reviewerId != null) {</span>
<span class="fc" id="L114">                csvWriter.append(String.valueOf(reviewerId));</span>
            }
<span class="fc" id="L116">            csvWriter.append(&quot;,&quot;);</span>
            
            // Comment (might be null)
<span class="fc" id="L119">            String comment = expenseWithUser.getApproval().getComment();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (comment != null) {</span>
<span class="fc" id="L121">                csvWriter.append(escapeCsvValue(comment));</span>
            }
<span class="fc" id="L123">            csvWriter.append(&quot;,&quot;);</span>
            
            // Review Date (might be null for pending expenses)
<span class="fc" id="L126">            String reviewDate = expenseWithUser.getApproval().getReviewDate();</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">            if (reviewDate != null) {</span>
<span class="fc" id="L128">                csvWriter.append(reviewDate);</span>
            }
            
<span class="fc" id="L131">            csvWriter.append(&quot;\n&quot;);</span>
<span class="fc" id="L132">        }</span>
        
<span class="fc" id="L134">        return csvWriter.toString();</span>
    }
    
    /**
     * Escape CSV values to handle commas, quotes, and newlines.
     * @param value the value to escape
     * @return escaped CSV value
     */
    private String escapeCsvValue(String value) {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L144">            return &quot;&quot;;</span>
        }
        
        // If value contains comma, quote, or newline, wrap in quotes and escape internal quotes
<span class="pc bpc" id="L148" title="3 of 6 branches missed.">        if (value.contains(&quot;,&quot;) || value.contains(&quot;\&quot;&quot;) || value.contains(&quot;\n&quot;)) {</span>
<span class="nc" id="L149">            return &quot;\&quot;&quot; + value.replace(&quot;\&quot;&quot;, &quot;\&quot;\&quot;&quot;) + &quot;\&quot;&quot;;</span>
        }
        
<span class="fc" id="L152">        return value;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>