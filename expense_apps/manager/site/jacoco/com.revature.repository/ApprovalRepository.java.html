<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApprovalRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">manager</a> &gt; <a href="index.source.html" class="el_package">com.revature.repository</a> &gt; <span class="el_source">ApprovalRepository.java</span></div><h1>ApprovalRepository.java</h1><pre class="source lang-java linenums">package com.revature.repository;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Optional;

/**
 * Repository for approval data access operations.
 * Handles database interactions for expense approval management.
 */
public class ApprovalRepository {
    private final DatabaseConnection databaseConnection;
<span class="fc" id="L17">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
    
<span class="fc" id="L19">    public ApprovalRepository(DatabaseConnection databaseConnection) {</span>
<span class="fc" id="L20">        this.databaseConnection = databaseConnection;</span>
<span class="fc" id="L21">    }</span>
    
    /**
     * Find an approval by expense ID.
     * @param expenseId the expense ID
     * @return Optional containing the approval if found, empty otherwise
     */
    public Optional&lt;Approval&gt; findByExpenseId(int expenseId) {
<span class="nc" id="L29">        String sql = &quot;SELECT id, expense_id, status, reviewer, comment, review_date FROM approvals WHERE expense_id = ?&quot;;</span>
        
<span class="nc" id="L31">        try (Connection conn = databaseConnection.getConnection();</span>
<span class="nc" id="L32">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L34">            stmt.setInt(1, expenseId);</span>
<span class="nc" id="L35">            ResultSet rs = stmt.executeQuery();</span>
            
<span class="nc bnc" id="L37" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L38">                return Optional.of(mapRowToApproval(rs));</span>
            }
            
<span class="nc bnc" id="L41" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L42">            throw new RuntimeException(&quot;Error finding approval for expense: &quot; + expenseId, e);</span>
<span class="nc" id="L43">        }</span>
        
<span class="nc" id="L45">        return Optional.empty();</span>
    }
    
    /**
     * Update approval status for an expense.
     * @param expenseId the expense ID
     * @param status the new approval status (&quot;approved&quot; or &quot;denied&quot;)
     * @param reviewerId the manager's user ID
     * @param comment optional comment from the manager
     * @return true if update was successful
     */
    public boolean updateApprovalStatus(int expenseId, String status, int reviewerId, String comment) {
<span class="fc" id="L57">        String sql = &quot;&quot;&quot;</span>
            UPDATE approvals 
            SET status = ?, reviewer = ?, comment = ?, review_date = ?
            WHERE expense_id = ?
            &quot;&quot;&quot;;
        
<span class="fc" id="L63">        String reviewDate = LocalDateTime.now().format(DATE_FORMATTER);</span>
        
<span class="fc" id="L65">        try (Connection conn = databaseConnection.getConnection();</span>
<span class="fc" id="L66">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="fc" id="L68">            stmt.setString(1, status);</span>
<span class="fc" id="L69">            stmt.setInt(2, reviewerId);</span>
<span class="fc" id="L70">            stmt.setString(3, comment);</span>
<span class="fc" id="L71">            stmt.setString(4, reviewDate);</span>
<span class="fc" id="L72">            stmt.setInt(5, expenseId);</span>
            
<span class="fc" id="L74">            int updatedRows = stmt.executeUpdate();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            return updatedRows &gt; 0;</span>
            
<span class="fc" id="L77">        } catch (SQLException e) {</span>
<span class="fc" id="L78">            throw new RuntimeException(&quot;Error updating approval for expense: &quot; + expenseId, e);</span>
        }
    }
    
    /**
     * Create a new approval record for an expense.
     * This should typically be called when an expense is first submitted.
     * @param expenseId the expense ID
     * @param status initial status (usually &quot;pending&quot;)
     * @return the created approval
     */
    public Approval createApproval(int expenseId, String status) {
<span class="nc" id="L90">        String sql = &quot;INSERT INTO approvals (expense_id, status) VALUES (?, ?)&quot;;</span>
        
<span class="nc" id="L92">        try (Connection conn = databaseConnection.getConnection();</span>
<span class="nc" id="L93">             PreparedStatement stmt = conn.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS)) {</span>
            
<span class="nc" id="L95">            stmt.setInt(1, expenseId);</span>
<span class="nc" id="L96">            stmt.setString(2, status);</span>
            
<span class="nc" id="L98">            int affectedRows = stmt.executeUpdate();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (affectedRows == 0) {</span>
<span class="nc" id="L100">                throw new RuntimeException(&quot;Creating approval failed, no rows affected.&quot;);</span>
            }
            
<span class="nc" id="L103">            ResultSet generatedKeys = stmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (generatedKeys.next()) {</span>
<span class="nc" id="L105">                int approvalId = generatedKeys.getInt(1);</span>
<span class="nc" id="L106">                Approval approval = new Approval();</span>
<span class="nc" id="L107">                approval.setId(approvalId);</span>
<span class="nc" id="L108">                approval.setExpenseId(expenseId);</span>
<span class="nc" id="L109">                approval.setStatus(status);</span>
<span class="nc" id="L110">                return approval;</span>
            } else {
<span class="nc" id="L112">                throw new RuntimeException(&quot;Creating approval failed, no ID obtained.&quot;);</span>
            }
            
<span class="nc" id="L115">        } catch (SQLException e) {</span>
<span class="nc" id="L116">            throw new RuntimeException(&quot;Error creating approval for expense: &quot; + expenseId, e);</span>
        }
    }
    
    private Approval mapRowToApproval(ResultSet rs) throws SQLException {
<span class="nc" id="L121">        Approval approval = new Approval();</span>
<span class="nc" id="L122">        approval.setId(rs.getInt(&quot;id&quot;));</span>
<span class="nc" id="L123">        approval.setExpenseId(rs.getInt(&quot;expense_id&quot;));</span>
<span class="nc" id="L124">        approval.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="nc" id="L125">        approval.setReviewer((Integer) rs.getObject(&quot;reviewer&quot;));</span>
<span class="nc" id="L126">        approval.setComment(rs.getString(&quot;comment&quot;));</span>
<span class="nc" id="L127">        approval.setReviewDate(rs.getString(&quot;review_date&quot;));</span>
<span class="nc" id="L128">        return approval;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>