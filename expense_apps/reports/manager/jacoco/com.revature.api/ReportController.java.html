<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">manager</a> &gt; <a href="index.source.html" class="el_package">com.revature.api</a> &gt; <span class="el_source">ReportController.java</span></div><h1>ReportController.java</h1><pre class="source lang-java linenums">package com.revature.api;

import com.revature.repository.ExpenseWithUser;
import com.revature.service.ExpenseService;
import io.javalin.http.Context;
import io.javalin.http.BadRequestResponse;
import io.javalin.http.InternalServerErrorResponse;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.List;

/**
 * REST controller for expense reporting operations.
 * Handles CSV report generation by various criteria.
 */
public class ReportController {
    private final ExpenseService expenseService;
<span class="fc" id="L20">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span>
    
<span class="fc" id="L22">    public ReportController(ExpenseService expenseService) {</span>
<span class="fc" id="L23">        this.expenseService = expenseService;</span>
<span class="fc" id="L24">    }</span>
    
    /**
     * Generate CSV report of all expenses.
     * GET /api/reports/expenses/csv
     */
    public void generateAllExpensesReport(Context ctx) {
        try {
<span class="fc" id="L32">            List&lt;ExpenseWithUser&gt; expenses = expenseService.getAllExpenses();</span>
<span class="fc" id="L33">            String csvContent = expenseService.generateCsvReport(expenses);</span>
            
<span class="fc" id="L35">            ctx.contentType(&quot;text/csv&quot;);</span>
<span class="fc" id="L36">            ctx.header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\&quot;all_expenses_report.csv\&quot;&quot;);</span>
<span class="fc" id="L37">            ctx.result(csvContent);</span>
            
<span class="fc" id="L39">        } catch (Exception e) {</span>
<span class="fc" id="L40">            throw new InternalServerErrorResponse(&quot;Failed to generate expenses report: &quot; + e.getMessage());</span>
<span class="fc" id="L41">        }</span>
<span class="fc" id="L42">    }</span>
    
    /**
     * Generate CSV report of expenses by employee.
     * GET /api/reports/expenses/employee/{employeeId}/csv
     */
    public void generateEmployeeExpensesReport(Context ctx) {
        try {
<span class="fc" id="L50">            int employeeId = ctx.pathParamAsClass(&quot;employeeId&quot;, Integer.class).get();</span>
<span class="fc" id="L51">            List&lt;ExpenseWithUser&gt; expenses = expenseService.getExpensesByEmployee(employeeId);</span>
<span class="fc" id="L52">            String csvContent = expenseService.generateCsvReport(expenses);</span>
            
<span class="fc" id="L54">            ctx.contentType(&quot;text/csv&quot;);</span>
<span class="fc" id="L55">            ctx.header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\&quot;employee_&quot; + employeeId + &quot;_expenses_report.csv\&quot;&quot;);</span>
<span class="fc" id="L56">            ctx.result(csvContent);</span>
            
<span class="fc" id="L58">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L59">            throw new BadRequestResponse(&quot;Invalid employee ID format&quot;);</span>
<span class="fc" id="L60">        } catch (Exception e) {</span>
<span class="fc" id="L61">            throw new InternalServerErrorResponse(&quot;Failed to generate employee expenses report: &quot; + e.getMessage());</span>
<span class="fc" id="L62">        }</span>
<span class="fc" id="L63">    }</span>
    
    /**
     * Generate CSV report of expenses by category.
     * GET /api/reports/expenses/category/{category}/csv
     */
    public void generateCategoryExpensesReport(Context ctx) {
        try {
<span class="fc" id="L71">            String category = ctx.pathParam(&quot;category&quot;);</span>
            
<span class="pc bpc" id="L73" title="1 of 4 branches missed.">            if (category == null || category.trim().isEmpty()) {</span>
<span class="fc" id="L74">                throw new BadRequestResponse(&quot;Category parameter is required&quot;);</span>
            }
            
<span class="fc" id="L77">            List&lt;ExpenseWithUser&gt; expenses = expenseService.getExpensesByCategory(category);</span>
<span class="fc" id="L78">            String csvContent = expenseService.generateCsvReport(expenses);</span>
            
<span class="fc" id="L80">            String safeCategory = category.replaceAll(&quot;[^a-zA-Z0-9_-]&quot;, &quot;_&quot;);</span>
<span class="fc" id="L81">            ctx.contentType(&quot;text/csv&quot;);</span>
<span class="fc" id="L82">            ctx.header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\&quot;category_&quot; + safeCategory + &quot;_expenses_report.csv\&quot;&quot;);</span>
<span class="fc" id="L83">            ctx.result(csvContent);</span>
            
<span class="fc" id="L85">        } catch (Exception e) {</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">            if (e instanceof BadRequestResponse) {</span>
<span class="fc" id="L87">                throw e;</span>
            }
<span class="fc" id="L89">            throw new InternalServerErrorResponse(&quot;Failed to generate category expenses report: &quot; + e.getMessage());</span>
<span class="fc" id="L90">        }</span>
<span class="fc" id="L91">    }</span>
    
    /**
     * Generate CSV report of expenses by date range.
     * GET /api/reports/expenses/daterange/csv?startDate=YYYY-MM-DD&amp;endDate=YYYY-MM-DD
     */
    public void generateDateRangeExpensesReport(Context ctx) {
        try {
<span class="fc" id="L99">            String startDateStr = ctx.queryParam(&quot;startDate&quot;);</span>
<span class="fc" id="L100">            String endDateStr = ctx.queryParam(&quot;endDate&quot;);</span>
            
<span class="pc bpc" id="L102" title="1 of 4 branches missed.">            if (startDateStr == null || endDateStr == null) {</span>
<span class="fc" id="L103">                throw new BadRequestResponse(&quot;Both startDate and endDate query parameters are required (format: YYYY-MM-DD)&quot;);</span>
            }
            
            // Validate date format
            try {
<span class="fc" id="L108">                LocalDate.parse(startDateStr, DATE_FORMATTER);</span>
<span class="fc" id="L109">                LocalDate.parse(endDateStr, DATE_FORMATTER);</span>
<span class="fc" id="L110">            } catch (DateTimeParseException e) {</span>
<span class="fc" id="L111">                throw new BadRequestResponse(&quot;Invalid date format. Use YYYY-MM-DD format&quot;);</span>
<span class="fc" id="L112">            }</span>
            
<span class="fc" id="L114">            List&lt;ExpenseWithUser&gt; expenses = expenseService.getExpensesByDateRange(startDateStr, endDateStr);</span>
<span class="fc" id="L115">            String csvContent = expenseService.generateCsvReport(expenses);</span>
            
<span class="fc" id="L117">            ctx.contentType(&quot;text/csv&quot;);</span>
<span class="fc" id="L118">            ctx.header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\&quot;expenses_&quot; + startDateStr + &quot;_to_&quot; + endDateStr + &quot;_report.csv\&quot;&quot;);</span>
<span class="fc" id="L119">            ctx.result(csvContent);</span>
            
<span class="fc" id="L121">        } catch (Exception e) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (e instanceof BadRequestResponse) {</span>
<span class="fc" id="L123">                throw e;</span>
            }
<span class="fc" id="L125">            throw new InternalServerErrorResponse(&quot;Failed to generate date range expenses report: &quot; + e.getMessage());</span>
<span class="fc" id="L126">        }</span>
<span class="fc" id="L127">    }</span>
    
    /**
     * Generate CSV report of pending expenses only.
     * GET /api/reports/expenses/pending/csv
     */
    public void generatePendingExpensesReport(Context ctx) {
        try {
<span class="fc" id="L135">            List&lt;ExpenseWithUser&gt; expenses = expenseService.getPendingExpenses();</span>
<span class="fc" id="L136">            String csvContent = expenseService.generateCsvReport(expenses);</span>
            
<span class="fc" id="L138">            ctx.contentType(&quot;text/csv&quot;);</span>
<span class="fc" id="L139">            ctx.header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\&quot;pending_expenses_report.csv\&quot;&quot;);</span>
<span class="fc" id="L140">            ctx.result(csvContent);</span>
            
<span class="fc" id="L142">        } catch (Exception e) {</span>
<span class="fc" id="L143">            throw new InternalServerErrorResponse(&quot;Failed to generate pending expenses report: &quot; + e.getMessage());</span>
<span class="fc" id="L144">        }</span>
<span class="fc" id="L145">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>